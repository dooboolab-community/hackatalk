(self.webpackChunkhackatalk_website=self.webpackChunkhackatalk_website||[]).push([[9270],{3905:function(e,n,t){"use strict";t.d(n,{Zo:function(){return h},kt:function(){return u}});var a=t(7294);function i(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function r(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?r(Object(t),!0).forEach((function(n){i(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):r(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,a,i=function(e,n){if(null==e)return{};var t,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||(i[t]=e[t]);return i}(e,n);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)t=r[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(i[t]=e[t])}return i}var o=a.createContext({}),p=function(e){var n=a.useContext(o),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},h=function(e){var n=p(e.components);return a.createElement(o.Provider,{value:n},e.children)},c={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},d=a.forwardRef((function(e,n){var t=e.components,i=e.mdxType,r=e.originalType,o=e.parentName,h=s(e,["components","mdxType","originalType","parentName"]),d=p(t),u=i,m=d["".concat(o,".").concat(u)]||d[u]||c[u]||r;return t?a.createElement(m,l(l({ref:n},h),{},{components:t})):a.createElement(m,l({ref:n},h))}));function u(e,n){var t=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var r=t.length,l=new Array(r);l[0]=d;var s={};for(var o in n)hasOwnProperty.call(n,o)&&(s[o]=n[o]);s.originalType=e,s.mdxType="string"==typeof e?e:i,l[1]=s;for(var p=2;p<r;p++)l[p]=t[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}d.displayName="MDXCreateElement"},4429:function(e,n,t){"use strict";t.r(n),t.d(n,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return o},toc:function(){return p},default:function(){return c}});var a=t(2122),i=t(9756),r=(t(7294),t(3905)),l={id:"channel",title:"Channel",sidebar_label:"Channel"},s=void 0,o={unversionedId:"server/channel",id:"server/channel",isDocsHomePage:!1,title:"Channel",description:"This page explains how the Channels in Hackatalk are structured and was created with the purpose of helping our contributors understand Hackatalk's data structure.",source:"@site/docs/server/channel.md",sourceDirName:"server",slug:"/server/channel",permalink:"/docs/server/channel",editUrl:"https://github.com/dooboolab/hackatalk/tree/master/website/docs/server/channel.md",version:"current",frontMatter:{id:"channel",title:"Channel",sidebar_label:"Channel"},sidebar:"docs",previous:{title:"Installation",permalink:"/docs/server/installation"},next:{title:"Membership",permalink:"/docs/server/membership"}},p=[{value:"Entity Relationship Model Diagram",id:"entity-relationship-model-diagram",children:[]},{value:"Creating a Channel",id:"creating-a-channel",children:[]},{value:"Creating channel with a message",id:"creating-channel-with-a-message",children:[]},{value:"Types of channels",id:"types-of-channels",children:[]},{value:"Leaving the channel",id:"leaving-the-channel",children:[]},{value:"Current status",id:"current-status",children:[]}],h={toc:p};function c(e){var n=e.components,t=(0,i.Z)(e,["components"]);return(0,r.kt)("wrapper",(0,a.Z)({},h,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"This page explains how the ",(0,r.kt)("inlineCode",{parentName:"p"},"Channels")," in ",(0,r.kt)("inlineCode",{parentName:"p"},"Hackatalk")," are structured and was created with the purpose of helping our contributors understand Hackatalk's data structure."),(0,r.kt)("p",null,"The ",(0,r.kt)("inlineCode",{parentName:"p"},"Channel"),"(aka ",(0,r.kt)("inlineCode",{parentName:"p"},"Chatroom"),") relational model is an important concept when it comes to building chatting apps. A ",(0,r.kt)("inlineCode",{parentName:"p"},"Channel")," aggregates users and prepares an environment for chatting.  Many relational models can exist in-between ",(0,r.kt)("inlineCode",{parentName:"p"},"User")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"Channel"),". These in-between relationships make it easier for developers to add complex business logic in their chat applications. Among these many realtionships, we will first look at the ",(0,r.kt)("inlineCode",{parentName:"p"},"Membership")," relationship."),(0,r.kt)("p",null,"When a user grants permission to other users to access a ",(0,r.kt)("inlineCode",{parentName:"p"},"Channel"),", a ",(0,r.kt)("inlineCode",{parentName:"p"},"Membership"),"relationship is created between the ",(0,r.kt)("inlineCode",{parentName:"p"},"Users"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"Membership"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"Channel"),". The ",(0,r.kt)("inlineCode",{parentName:"p"},"memberships")," table has a ",(0,r.kt)("inlineCode",{parentName:"p"},"userId")," and a ",(0,r.kt)("inlineCode",{parentName:"p"},"channelId")," that links ",(0,r.kt)("inlineCode",{parentName:"p"},"Users")," to their ",(0,r.kt)("inlineCode",{parentName:"p"},"Channel"),"."),(0,r.kt)("p",null," Another scenario is when the user wants to manage the sound(vibrate, silent, etc) of each channel, we can create ",(0,r.kt)("inlineCode",{parentName:"p"},"Sound")," relation. Like this, we can add more relations in between to handle more complex logic."),(0,r.kt)("h2",{id:"entity-relationship-model-diagram"},"Entity Relationship Model Diagram"),(0,r.kt)("img",{src:"https://user-images.githubusercontent.com/27461460/88914167-2de67d80-d29d-11ea-8230-6762a4cfe1b4.png",width:"1000"}),(0,r.kt)("p",null,"The decision was made in our first proposal in designing ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Entity%E2%80%93relationship_model"},"Entity Relation Model"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Note that the above ",(0,r.kt)("a",{parentName:"li",href:"https://creately.com/blog/diagrams/uml-diagram-types-examples"},"UML")," diagram is not recent and this is keep\nchanging as we continue implementing cool features.")),(0,r.kt)("p",null,"As you can see in the diagram above, there are ",(0,r.kt)("inlineCode",{parentName:"p"},"userAlert"),", ",(0,r.kt)("inlineCode",{parentName:"p"},"userMode")," as well as ",(0,r.kt)("inlineCode",{parentName:"p"},"type")," of membership which determines what type of membership permissions a user has in the ",(0,r.kt)("inlineCode",{parentName:"p"},"Channel")," (view only, leader ...etc). We usually call this a ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Single_Table_Inheritance"},"single table inheritance")," where a single table can have multiple models. We are presenting this diagram to clarify the relationship model for the creation of channels for our contributors. Note that the features that each table has will continue to change."),(0,r.kt)("h2",{id:"creating-a-channel"},"Creating a Channel"),(0,r.kt)("p",null,"Below is a description of how to find a channel using the ",(0,r.kt)("inlineCode",{parentName:"p"},"unique")," number of users in each channel. "),(0,r.kt)("p",null,"In most ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Object-relational_mapping"},"ORM"),"(Object Relational Mapping), developers use the ",(0,r.kt)("a",{parentName:"p",href:"https://stackoverflow.com/questions/42719750/sequelize-relation-with-where-in-array?rq=1"},"IN operator"),"."),(0,r.kt)("p",null,"Developers usually use this to find if subarray matches in query. This is also possible with ",(0,r.kt)("a",{parentName:"p",href:"https://www.prisma.io/docs/reference/tools-and-interfaces/prisma-client/filtering#filter-on-related-records"},"prisma filtering")," in a similar way. However, the ",(0,r.kt)("inlineCode",{parentName:"p"},"in")," operator will return all rows that contain ","[ 'tom', 'jerry' ]"," instead of unique one. "),(0,r.kt)("img",{src:"https://user-images.githubusercontent.com/27461460/90379570-da09d000-e0b5-11ea-8215-df2828108b58.png",width:"200"}),(0,r.kt)("p",null,"When you query for users, ",(0,r.kt)("inlineCode",{parentName:"p"},"tom")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"jerry"),", using the IN operator, it will return all the other arrays which ","[ 'tom' , 'jerry' ]"," exists. A similar discussion could be found on ",(0,r.kt)("a",{parentName:"p",href:"https://v1.prisma.io/forum/t/query-for-exact-match-of-array-of-ids/5700/17"},"Prisma1 forum"),"."),(0,r.kt)("p",null,"We resolve the above problem by checking the unique number of users  in addition to the userIDs of a ",(0,r.kt)("inlineCode",{parentName:"p"},"Channel"),". If you have any other suggestions on better code other than the one below, please let shoot us a PR request! The code below is located in ",(0,r.kt)("inlineCode",{parentName:"p"},"Hackatalk/server/src/types/resolvers/Channel/mutation.ts"),". (08/17/2020)"),(0,r.kt)("p",null,"The code below is doing this:"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"userIds")," = All the userIds in the channel we are trying to find minus the auth user."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"findChannelWithUserIds()")," first stores all the ",(0,r.kt)("inlineCode",{parentName:"li"},"channels")," that contain the ",(0,r.kt)("inlineCode",{parentName:"li"},"userIds"),". "),(0,r.kt)("li",{parentName:"ol"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"totalUsers")," stores the length of ",(0,r.kt)("inlineCode",{parentName:"li"},"userIds")," we are trying to find. "),(0,r.kt)("li",{parentName:"ol"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"for loop")," loops through the channels and find the channel that has the same number of users as ",(0,r.kt)("inlineCode",{parentName:"li"},"totalUsers"),"."),(0,r.kt)("li",{parentName:"ol"},"The matching channel is stored in ",(0,r.kt)("inlineCode",{parentName:"li"},"existingChannel")," and returned.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const findChannelWithUserIds = async () => {\n  const channels = await ctx.prisma.channel.findMany({\n    include: {\n      membership: {\n        select: {\n          userId: true,\n          membershipType: true,\n        },\n      },\n    },\n    where: {\n      membership: {\n        every: {\n          userId: { in: [userId, ...userIds] },\n        },\n      },\n    },\n  });\n\n  const totalUsers = userIds.length + 1; // +1 for auth user\n\n  let existingChannel: Channel;\n\n  for (const channel of channels) {\n    if (totalUsers === channel.membership.length) {\n      existingChannel = channel;\n      break;\n    }\n  }\n\n  return existingChannel;\n};\n\nconst existingChannel = await findChannelWithUserIds();\n")),(0,r.kt)("p",null,"This is how we manage the ",(0,r.kt)("inlineCode",{parentName:"p"},"unique")," channel with unique array of userIds."),(0,r.kt)("h2",{id:"creating-channel-with-a-message"},"Creating channel with a message"),(0,r.kt)("p",null,"It is also possible to create channel with a message.\nThe code below is also located at ",(0,r.kt)("inlineCode",{parentName:"p"},"Hackatalk/server/src/types/resolvers/Channel/mutation.ts"),". "),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"message && await createMessage(message, existingChannel.id);\n")),(0,r.kt)("p",null,"We check if the message argument is not null then call ",(0,r.kt)("inlineCode",{parentName:"p"},"createMessage"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const createMessage = (\n  { text, messageType = MessageType.text, fileUrls = [], imageUrls = [] } : Message,\n  channelId: string,\n) => ctx.prisma.message.create({\n  data: {\n    text,\n    messageType,\n    fileUrls: { set: fileUrls },\n    imageUrls: { set: imageUrls },\n    channel: { connect: { id: channelId } },\n    sender: { connect: { id: userId } },\n  },\n});\n")),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Currently, we are facing issues in redefining types if ",(0,r.kt)("inlineCode",{parentName:"li"},"Message")," since we can't get it from anywhere (08/17/2020).")),(0,r.kt)("h2",{id:"types-of-channels"},"Types of channels"),(0,r.kt)("p",null,"There are two types of channels defined in ",(0,r.kt)("inlineCode",{parentName:"p"},"ChannelType")," which are ",(0,r.kt)("strong",{parentName:"p"},"private")," and ",(0,r.kt)("strong",{parentName:"p"},"public"),"."),(0,r.kt)("p",null,"The ",(0,r.kt)("strong",{parentName:"p"},"public")," channel can have a duplicate array of ",(0,r.kt)("inlineCode",{parentName:"p"},"users")," and they can be created continuously while the ",(0,r.kt)("strong",{parentName:"p"},"private")," channel needs unique users."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"By passing array of ",(0,r.kt)("inlineCode",{parentName:"li"},"userIds")," in ",(0,r.kt)("inlineCode",{parentName:"li"},"ChannelCreateInput"),", users will grant the ",(0,r.kt)("inlineCode",{parentName:"li"},"Permission")," to a newly created channel. If the channel is ",(0,r.kt)("strong",{parentName:"li"},"public"),", there will be a different ",(0,r.kt)("inlineCode",{parentName:"li"},"permissionType")," for each user and only one of them will have the ",(0,r.kt)("inlineCode",{parentName:"li"},"owner")," permission.")),(0,r.kt)("h2",{id:"leaving-the-channel"},"Leaving the channel"),(0,r.kt)("p",null,"This section explains the process for when the user leaves a channel. Currently, we have only described the changes scenario for the 'private' channel. The public channel will soon be updated as we make more progress!"),(0,r.kt)("p",null,"For the private channel, the ",(0,r.kt)("inlineCode",{parentName:"p"},"isVisible")," field exists in ",(0,r.kt)("inlineCode",{parentName:"p"},"Membership")," model. When the user leaves the channel, the ",(0,r.kt)("inlineCode",{parentName:"p"},"isVisible")," will be set to ",(0,r.kt)("inlineCode",{parentName:"p"},"false")," and this will affect ",(0,r.kt)("inlineCode",{parentName:"p"},"myChannels")," query results because the channel that the user wishes to leave will no longer be displayed on on their list of channels."),(0,r.kt)("p",null,"However, the ",(0,r.kt)("inlineCode",{parentName:"p"},"hidden")," channel will be set to ",(0,r.kt)("inlineCode",{parentName:"p"},"visible")," by default when a new ",(0,r.kt)("strong",{parentName:"p"},"message")," has been created. This is defined in ",(0,r.kt)("inlineCode",{parentName:"p"},"changeVisibilityWhenInvisible")," function."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const changeVisibilityWhenInvisible = () => ctx.prisma.membership.update({\n  data: { isVisible: true },\n  where: {\n    userId_channelId: {\n      userId,\n      channelId: existingChannel.id,\n    },\n  },\n});\n")),(0,r.kt)("h2",{id:"current-status"},"Current status"),(0,r.kt)("h4",{id:"08172020"},"08/17/2020"),(0,r.kt)("p",null,"In our mobile application, we only have a ",(0,r.kt)("strong",{parentName:"p"},"private")," channel senario and the ",(0,r.kt)("strong",{parentName:"p"},"public")," channel senario will be updated in future when things go well. The ",(0,r.kt)("strong",{parentName:"p"},"public")," channel will be any kind of group chats except the ",(0,r.kt)("a",{parentName:"p",href:"https://slack.com/intl/en-kr/help/articles/212281468-What-is-a-direct-message"},"direct messages in slack"),"."))}c.isMDXComponent=!0}}]);