# Migration `20200730204657-init-database-proposal`

This migration has been generated by hyochan at 7/30/2020, 8:46:57 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "Gender" AS ENUM ('male', 'female');

CREATE TYPE "AuthType" AS ENUM ('email', 'facebook', 'google', 'apple');

CREATE TYPE "MembershipType" AS ENUM ('owner', 'admin', 'member');

CREATE TYPE "AlertMode" AS ENUM ('sound', 'vibrate', 'silent');

CREATE TYPE "ChannelType" AS ENUM ('private', 'public');

CREATE TYPE "MessageType" AS ENUM ('text', 'photo', 'file');

CREATE TABLE "hackatalk"."User" (
"birthday" timestamp(3)   ,"createdAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,"deletedAt" timestamp(3)   ,"email" text   ,"gender" "Gender"  ,"id" text  NOT NULL ,"isOnline" boolean   DEFAULT false,"lastSignedIn" timestamp(3)   ,"name" text   ,"nickname" text   ,"password" text   ,"phone" text   ,"photoURL" text []  ,"statusMessage" text   ,"thumbURL" text   ,"updatedAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,"verified" boolean   DEFAULT false,
    PRIMARY KEY ("id"))

CREATE TABLE "hackatalk"."Notification" (
"createdAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,"device" text   ,"id" SERIAL,"os" text   ,"token" text  NOT NULL ,"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "hackatalk"."Profile" (
"authType" "AuthType"  ,"id" SERIAL,"socialId" text   ,"userId" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE TABLE "hackatalk"."Friend" (
"createdAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,"deletedAt" timestamp(3)   ,"friendId" text  NOT NULL ,"updatedAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,"userId" text  NOT NULL ,
    PRIMARY KEY ("userId","friendId"))

CREATE TABLE "hackatalk"."Membership" (
"alertMode" "AlertMode"  DEFAULT E'sound',"channelId" text  NOT NULL ,"createdAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,"membershipType" "MembershipType" NOT NULL DEFAULT E'member',"updatedAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,"userId" text  NOT NULL ,
    PRIMARY KEY ("userId","channelId"))

CREATE TABLE "hackatalk"."Channel" (
"channelType" "ChannelType" NOT NULL ,"createdAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,"deletedAt" timestamp(3)   ,"id" text  NOT NULL ,"name" text   ,"updatedAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY ("id"))

CREATE TABLE "hackatalk"."Message" (
"channelId" text  NOT NULL ,"createdAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,"deletedAt" timestamp(3)   ,"fileUrls" text []  ,"id" SERIAL,"imageUrls" text []  ,"messageType" "MessageType" NOT NULL DEFAULT E'text',"senderId" text  NOT NULL ,"text" text   ,"updatedAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY ("id"))

CREATE TABLE "hackatalk"."Reply" (
"createdAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,"deletedAt" timestamp(3)   ,"fileUrls" text []  ,"id" SERIAL,"imageUrls" text []  ,"messageId" integer  NOT NULL ,"messageType" "MessageType" NOT NULL DEFAULT E'text',"senderId" text  NOT NULL ,"text" text   ,"updatedAt" timestamp(3)   DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY ("id"))

CREATE TABLE "hackatalk"."Reaction" (
"id" SERIAL,"messageId" integer  NOT NULL ,"replyId" integer  NOT NULL ,"userId" text  NOT NULL ,"value" text  NOT NULL ,
    PRIMARY KEY ("id"))

CREATE UNIQUE INDEX "User.email" ON "hackatalk"."User"("email")

CREATE UNIQUE INDEX "Profile.userId" ON "hackatalk"."Profile"("userId")

CREATE UNIQUE INDEX "Membership_channelId" ON "hackatalk"."Membership"("channelId")

ALTER TABLE "hackatalk"."Notification" ADD FOREIGN KEY ("userId")REFERENCES "hackatalk"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Notification" ADD FOREIGN KEY ("userId")REFERENCES "hackatalk"."User"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Profile" ADD FOREIGN KEY ("userId")REFERENCES "hackatalk"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Friend" ADD FOREIGN KEY ("userId")REFERENCES "hackatalk"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Friend" ADD FOREIGN KEY ("friendId")REFERENCES "hackatalk"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Membership" ADD FOREIGN KEY ("userId")REFERENCES "hackatalk"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Membership" ADD FOREIGN KEY ("channelId")REFERENCES "hackatalk"."Channel"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Message" ADD FOREIGN KEY ("channelId")REFERENCES "hackatalk"."Channel"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Message" ADD FOREIGN KEY ("senderId")REFERENCES "hackatalk"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Message" ADD FOREIGN KEY ("channelId")REFERENCES "hackatalk"."Channel"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Reply" ADD FOREIGN KEY ("senderId")REFERENCES "hackatalk"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Reply" ADD FOREIGN KEY ("messageId")REFERENCES "hackatalk"."Message"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Reply" ADD FOREIGN KEY ("messageId")REFERENCES "hackatalk"."Message"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Reaction" ADD FOREIGN KEY ("userId")REFERENCES "hackatalk"."User"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Reaction" ADD FOREIGN KEY ("messageId")REFERENCES "hackatalk"."Message"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "hackatalk"."Reaction" ADD FOREIGN KEY ("replyId")REFERENCES "hackatalk"."Reply"("id") ON DELETE CASCADE  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200730204657-init-database-proposal
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,170 @@
+generator client {
+  provider = "prisma-client-js"
+}
+
+datasource db {
+  provider = "postgresql"
+  url = "***"
+}
+
+enum Gender {
+  male
+  female
+}
+
+enum AuthType {
+  email
+  facebook
+  google
+  apple
+}
+
+model User {
+  id                     String                  @default(cuid()) @id
+  email                  String?                 @unique
+  password               String?
+  name                   String?
+  nickname               String?
+  thumbURL               String?
+  photoURL               String[]
+  birthday               DateTime?
+  gender                 Gender?
+  phone                  String?
+  statusMessage          String?
+  verified               Boolean?                @default(false)
+  lastSignedIn           DateTime?
+  isOnline               Boolean?                @default(false)
+  createdAt              DateTime?               @default(now())
+  updatedAt              DateTime?               @default(now()) @updatedAt
+  deletedAt              DateTime?
+
+  profile                Profile?
+  notifications          Notification[]          @relation("Notification")
+  friends                Friend[]                @relation("Friend")
+}
+
+model Notification {
+  id                     Int                     @default(autoincrement()) @id
+  token                  String
+  device                 String?
+  os                     String?
+  userId                 String
+  user                   User                    @relation(fields: [userId], references: [id])
+  createdAt              DateTime?               @default(now())
+}
+
+model Profile {
+  id                     Int                     @default(autoincrement()) @id
+  socialId               String?
+  authType               AuthType?
+
+  userId                 String                  @unique
+  User                   User                    @relation(fields: [userId], references: [id])
+}
+
+model Friend {
+  createdAt              DateTime?               @default(now())
+  updatedAt              DateTime?               @default(now()) @updatedAt
+  deletedAt              DateTime?
+
+  userId                 String
+  user                   User                    @relation(fields: [userId], references: [id])
+  friendId               String
+  friend                 User                    @relation(name: "Friend", fields: [friendId], references: [id])
+
+  @@id([userId, friendId])
+}
+
+enum MembershipType {
+  owner
+  admin
+  member
+}
+
+enum AlertMode {
+  sound
+  vibrate
+  silent
+}
+
+model Membership {
+  alertMode              AlertMode?              @default(sound)
+  membershipType         MembershipType          @default(member)
+  createdAt              DateTime?               @default(now())
+  updatedAt              DateTime?               @default(now()) @updatedAt
+
+  userId                 String
+  user                   User                    @relation(fields: [userId], references: [id])
+  channelId              String
+  channel                Channel                 @relation(fields: [channelId], references: [id])
+
+  @@id([userId, channelId])
+}
+
+enum ChannelType {
+  private
+  public
+}
+
+model Channel {
+  id                     String                  @default(cuid()) @id
+  channelType            ChannelType
+  name                   String?
+  messages               Message[]               @relation("Message")
+  membership             Membership
+  createdAt              DateTime?               @default(now())
+  updatedAt              DateTime?               @default(now()) @updatedAt
+  deletedAt              DateTime?
+}
+
+enum MessageType {
+  text
+  photo
+  file
+}
+
+model Message {
+  id                     Int                     @default(autoincrement()) @id
+  messageType            MessageType             @default(text)
+  text                   String?
+  imageUrls              String[]
+  fileUrls               String[]
+  reactions              Reaction[]
+  replies                Reply[]                 @relation("Reply")
+  createdAt              DateTime?               @default(now())
+  updatedAt              DateTime?               @default(now()) @updatedAt
+  deletedAt              DateTime?
+
+  channelId              String
+  channel                Channel                 @relation(fields: [channelId], references: [id])
+  senderId               String
+  sender                 User                    @relation(fields: [senderId], references: [id])
+}
+
+model Reply {
+  id                     Int                     @default(autoincrement()) @id
+  messageType            MessageType             @default(text)
+  text                   String?
+  imageUrls              String[]
+  fileUrls               String[]
+  reactions              Reaction[]
+  createdAt              DateTime?               @default(now())
+  updatedAt              DateTime?               @default(now()) @updatedAt
+  deletedAt              DateTime?
+
+  senderId               String
+  sender                 User                    @relation(fields: [senderId], references: [id])
+  messageId              Int
+  message                Message                 @relation(fields: [messageId], references: [id])
+}
+
+model Reaction {
+  id                     Int                     @default(autoincrement()) @id
+  value                  String
+  userId                 String
+  user                   User                    @relation(fields: [userId], references: [id])
+  messageId              Int
+  message                Message                 @relation(fields: [messageId], references: [id])
+  replyId                Int
+  reply                  Reply                   @relation(fields: [replyId], references: [id])
+}
```


